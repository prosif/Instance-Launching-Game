<!DOCTYPE html>
<html>
  <head>
    <title>Ayy</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> 
    <style>
        h1{
            position: absolute;
            color: white;
        }
        body{
            margin: 0;
        }
    </style>
  </head>

  <body>
    <div id="content"></div>

    <script type="text/jsx">
      var Game = React.createClass({

         getInitialState: function(){
            return({
               points: 0,
               activeEnemies: 0,
               enemies: {},
               playerXPos: 0,
               clearedWave: false
            });
         },

         componentDidMount: function(){
           this.generateNew();
         },

         handlePass: function(){
            this.setState({
               points: this.state.points + 1
            });
         },

         generateNew: function(){
            var enemies = this.state.enemies;
            var enemyLength = Object.keys(enemies).length;
            enemies[enemyLength] = <Enemy id={enemyLength} pass={this.handlePass} generate={this.generateNew} />;
            this.setState({
                enemies: enemies
            });
         },

         handlePlayerMovement: function(pos){
           this.setState({
               playerXPos: pos
           });
           console.log(this.state.playerXPos);
         },

         render: function() {
            var gameWidth = $(window).width();
            var divStyle = {
               background: 'black',
               height: '500px',
               width: gameWidth
            };
            return (
               <div style={divStyle} className="game">
               <h1>{this.state.points}</h1>
               <Player onMove={this.handlePlayerMovement} />
               {this.state.enemies}
               </div>
            );
         }
      });

      var Enemy = React.createClass({
         componentDidMount: function(){ 
            setInterval(function(){this.moveDown()}.bind(this), 1000);
         },

         reset: function(){
           this.setState(this.getInitialState());
         },

         moveDown: function(){
            if(this.state.yPos >= 400 && !this.state.passed){
                this.props.pass();
                this.setState({
                   passed: true
                });
                this.reset();
            }

            else {
                this.setState({yPos: this.state.yPos + 100});
            }
         },
 
         getInitialState: function(){
            return({
               xPos: Math.random() * 1180,
               yPos: 0,
               passed: false
            })
         },
         
         render: function(){
            var divStyle = {
               background: 'blue',
               height: '100px',
               width: '100px',
               position: 'absolute',
               left: this.state.xPos,
               top: this.state.yPos
            };

            if(!this.state.passed){
               return(
                 <div id={this.props.id} style={divStyle} className="enemy" />
               );
            }

            return <div />
         }
      });

      var Player = React.createClass({

         handleKeyDown: function(e) {
          keyCode = e.keyCode;
          switch (keyCode) {
              case 37:
                  e.preventDefault();
                  this.setState({xPos: this.state.xPos - 20});
                  break;
              case 39:
                  e.preventDefault();
                  this.setState({xPos: this.state.xPos + 20});
                  break;
          }
          this.props.onMove(this.state.xPos);
         },

         componentDidMount: function(){
            $(document.body).on('keydown', this.handleKeyDown);
         },

         getInitialState: function(){
            return({
               xPos: 0,
               yPos: 400
            })
         },
         
         render: function(){
            var divStyle = {
               background: 'red',
               height: '100px',
               width: '100px',
               position: 'absolute',
               left: this.state.xPos,
               top: this.state.yPos
            };
            return(
              <div style={divStyle} className="box" />
            );
         }
      });
      React.render(<Game />,document.getElementById('content'));
    </script>
  </body>
</html>
